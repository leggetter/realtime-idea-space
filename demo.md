SETUP

* Ensure ngrok is running `ngrok http --subdomain=realtime --host-header=localhost 55401`

* Connect mobile and use Vysor to show UI.


OVERVIEW

* Show basic registration and 2FA

* Show idea creation

* Show adding comments


REALTIME!

Update comments to appear as they are added using SignalR
  
* SignalR is pre-installed
* Ensure SignalR can handle requests by adding the following to `Startup.cs`:

```
app.MapSignalR();
```

* Create a new SignalR Hub: `Hubs/CommentHub.cs`
* Add static function to send new comments to all clients

```
public static void NewCommentAdded(CommentModel comment)
{
	var hubContext = GlobalHost.ConnectionManager.GetHubContext<CommentHub>();
	hubContext.Clients.All.AddNewComment(comment);
}
```

* Add scripts section in stages to `Idea\Details.cshtml`:

* Add @scripts and references (include snippet)

```
@section scripts {
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->

	<script>
	$(function() {

	});
	</script>
}
```

* Add SignalR outline script and explain

```
// Reference the auto-generated proxy for the hub.
var commentHub = $.connection.commentHub;

// Create a function that the hub can call back to display comments.
commentHub.client.addNewComment = function(comment) {

};

// Start the connection.
$.connection.hub.start().done(function () {
	console.log('hub started')
});
```

* Add `addNewComment` content (via snippet)

```
var commentEl =   $('<div class="idea-comment">' +
                        '<span>' + comment.Created + '</span>' +
                        '<p>' + comment.Text + '</p>' +
                    '</div>').hide();
$('#comments').prepend(commentEl);
commentEl.slideDown();
```

* Run the application, view the comment details in two browser windows side-by-side and show the updates.


WEBHOOKS & SMS

SMS is pretty real-time and is available to everybody. So let's add the ability to comment on ideas via SMS.

* Uncomment the number provisioning code in `IdeaController.cs`

* When an SMS is sent to that number we want our application to know about it. For local development I'm using ngrok as a localtunnel that exposes my own machine.

* Show `CommentController` and `SmsWebhook` route.

* Code getting main values from `Request`

```
var fromNumber = Request["msisdn"];
var commentPhoneNumber = Request["to"];
var text = Request["text"];
```

* Get required info from the DB: from user based on number, work out from Id from there.

```
var fromUser = db.Users.First(user => user.PhoneNumber == fromNumber);

// If there isn't a user registered with this phone number then we'll
// treat the comment as anonymous. We can use a check to see if the
// UserID is a GUID. If not, they're anonymous.
string fromUserId = (fromUser != null ? fromUser.Id : fromNumber);
```

* Get IdeaId based on the to/comment phone number

```
Guid ideaId = db.IdeaModels.First(idea => idea.CommentPhoneNumber == commentPhoneNumber).Id;
```

* Create comment, save and catch

```
var comment = new CommentModel(ideaId, text, fromUserId);
db.IdeaComments.Add(comment);

try
{
    db.SaveChanges();

    // Real-Time?
}
catch(Exception ex)
{
}
```

* Add simple real-time call that uses the existing SignalR Hub and JS we have in place.

```
Hubs.CommentHub.NewCommentAdded(comment);
```
